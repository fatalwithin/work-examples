# CBA mail server

Почтовый сервер в первую очередь для задач рассылок, связанных с обучением Cloud-Based Education.

## Prerequisites

Продукты для рассмотрения:
- www.iredmail.org
- modoboa
- mailcow
- ... to be discussed later...

## Краткий анализ продуктов/решений для коробочного развертывания сервиса электронной почты

### iRedmail

Состав решения:
- mailserver - Postfix
- MTA - Dovecot
- Web-server - Apache/Nginx
- backend DB - MySQL/MariaDB/PostgreSQL
- LDAP - OpenLDAP/OpenBSD ldap
- cache - memcached
- security/AV/Antispam - Amavisd-new (проксирующий сервис для антивируса и антиспама - на бэке сидят ClamAV и SpamAssassin)
- grey/white/black-list - iRedAPD (самописное решение)
- api server для управления рассылками - самописный
- веб-админка - iRedAdmin (самописное решение)
- мониторинг трафика - NetData

Уникальные фичи:
- наличие коммерческой версии с платной поддержкой
- собственный сервис легкого развертывания и обновления - iRedMail Easy: работает по подписке, требует открытия SSH наружу, фактически это деплой с серверов разработчиков через Ansible.


Плюсы:
- форсированный транспорт через SSL
- пароли хранятся в SSHA512 или BCRYPT
- webmail
- поддерживаются Red Hat, CentOS, Debian, Ubuntu, FreeBSD
- web admin panel
- SpamAssassin, ClamAV, SPF, DKIM
- все популярные БД в качестве бекэнда
- iRedMail Easy

Минусы:
- web admin с ограниченными возможностями, полный функционал только в платной версии
- кушает много ресурсов - минимум 2 гига памяти и до 16 гигов и больше, если нужны функции groupware - веб-почта, календари, синхронизация контактов, ActiveSync. Больше всего ресурсов без учета groupware ест антивирус и антиспам.
- iRedmail Easy - требует отдельной учетки и подписки
- НЕ умеет работать с SELinux!
- нет docker-образов
- инсталлятор консольный и без возможности тонкой настройки


### Modoboa

Состав решения:
- mailserver - postfix
- MTA - dovecot
- backend DB - PostgreSQL/MySQL/MariaDB/SQLite
- LDAP - OpenLDAP/MS AD через Python LDAP Client либо через Django LDAP auth backend
- cache - ?
- security/AV/Antispam - Amavis (только в составе инсталлятора)
- grey/white/blacklist - Amavis (только в составе инсталлятора)
- Web Server - Apache/Nginx/uWSGI
- web admin - самописный сервис
- webmail - самописный сервис
- мониторинг и статистика - самописный сервис
- carddav/caldav - Radicale
- REST API - есть, судя по всему - в основном для доступа к расшаренным календарям и событиям


Уникальные фичи:
- ?

Плюсы:
- всё написано на Python+Django - практически вся конфигурация реализована на python-скриптах 
- все исходники есть на гитхабе, можно доработать самим при необходимости
- лёгкий (в теории) апгрейд при помощи Python

Минусы:
- из коробки поддерживаются только дистрибутивы Linux на базе Debian и CentOS - впрочем для проекта этого достаточно
- требует python для работы инсталлятора
- инсталлятор в стадии беты
- инсталлятор требует 2ГБ памяти
- настройки безопасности, антивируса, антиспама итд - не описаны в документации, и эти компоненты устанавливаются "из коробки" только в составе пакетного инсталлятора
- нет сервиса кэширования (или настраивается отдельно)

### Mailcow

Состав решения:
- mailserver - Postfix
- MTA - Dovecot
- backend DB - MySQL
- LDAP - ?
- cache - Redis, Memcached
- security/AV/Antispam - ClamAV, Solr, RSpamd, Netfilter (для интеграции с Fail2Ban)
- grey/white/blacklist - 
- web server - Nginx
- web admin - самописный
- webmail - самописный
- мониторинг и статистика - Watchdog

Уникальные фичи:
- web ui для антиспам-фильтрации на базе Rspamd 
- 

Плюсы:
- есть демо-страничка, где можно пощупать админку: demo.mailcow.email 
- докеризируется! есть набор контейнеров по сервисам, слинкованных в одну bridge-сеть 
- также есть и набор docker volumes для обработки и хранения persistent-данных
- работает через docker-compose - как плюс так и минус
- инструкции из коробки для интеграции с portainer
- !!! инструкции из коробки для интеграции с gogs и gitea!
- инструкции из коробки для настройки всех популярных почтовых клиентов (и мобильных тоже!)
- продукт активно развивается и обновляется, последний релиз в 10-х числах марта 2019
- удобная настройка антиспама через GUI 
- готовые скрипты для бекапа и восстановления
- все самые важные файлы конфигурации мапятся с хостового сервера из одной директории на все связанные контейнеры, дерево файлов есть в документации

Минусы:
- дефолтная сеть - 172.22.0.0
- работает через docker-compose - легкость настройки, но сложность переноса на другие платформы, например на kubernetes 
- при развертывании на публичных облачных сервисах может понадобиться изменять или отключать настройки cloud-init в части сетевых интерфейсов
- необходимость в ряде случаев менять MTU, особенно при развертывании поверх Openstack
- надо поднимать отдельный вебсервер (Apache или Nginx) с ролью обратного прокси, вероятнее всего на хостовой ВМ по отношению к контейнерам.
- 



## Технические требования к сервису

1) Открытый код (желательно)
2) Работа под Linux
3) Докеризация/контейнеризация (желательно)
4) возможность работы на ВМ с малым количеством ресурсов (от 1 vCPU и 1GB RAM)

## Бизнес-требования

1) Чтобы ходила почта :)
2) Возможность заводить ящики до 2500 пользователям (при возникновении такой необходимости)
3) Внешний по отношению к СБТ сервис 

## Очередность рассмотрения и анализа на базе плюсов/минусов/фич рассматриваемых продуктов

На текущий момент приоритет следующий:
1) (наивысший): Mailcow
2) Modoboa
3) iRedmail